# This is a custom implementation of a nginx "stack" used for exposing docker deployments.
#
# We use nginx+extras and certbot to manage our stacks from here forth.
# Traefik is capable, but I am familiar with nginx. Till k8s, nginx...
#
# nginx-extras-oci ?
# - A minimal and self-contained docker image for nginx w/ extras. 
# - An IaC friendly alpine based build of nginx.
#
# DockerHub: https://hub.docker.com/r/prplanit/nginx-extras-oci
# GitLab: https://gitlab.prplanit.com/precisionplanit/nginx-extras-oci
# Docker Pulls: `prplanit/nginx-extras-oci:latest`
# 
# Â© 2025 ~ AntParade / HomelabHelpDesk / PrecisionPlanIT / SoFMeRight
# Pemission to *use* is granted and optional as well are thank you(s).

---

version: "3.9"

x-logging: &loki
  driver: loki
  options:
    labels: "ap.mon.hostname,ap.mon.srvcname"
    loki-external-labels: "ap_mon_jobsname=docker"
    loki-url: "http://monitoring:3100/loki/api/v1/push"
    loki-retries: "2"
    loki-batch-size: "400"
    loki-timeout: "1s"
    loki-max-backoff: "800ms"
    mode: "non-blocking"

services:

  certbot:
    container_name: certbot
    #depends_on:
      #nginx-extras-oci:
        #condition: service_healthy
        #restart: true
    image: certbot/dns-cloudflare:latest
    labels:
      - "ap.mon.hostname=cell-membrane"
      - "ap.mon.srvcname=certbot"
    logging:
      <<: *loki
    # EITHER share PID ns and HUP nginx PID 1 (see note #2 below)...
    pid: "service:nginx-extras-oci"
    restart: always
    volumes:
      - /opt/docker/nginx-extras/letsencrypt:/etc/letsencrypt
      - /opt/docker/nginx-extras/secrets/dns_cloudflare_api_token.ini:/secrets/dns_cloudflare_api_token.ini:ro
    entrypoint:
      - sh
      - -c
      - |
        while :; do
          certbot renew \
            --dns-cloudflare \
            --dns-cloudflare-credentials /secrets/dns_cloudflare_api_token.ini \
            --preferred-challenges dns \
            --non-interactive --agree-tos \
            --deploy-hook 'kill -HUP 1' ;
          sleep 12h
        done

  nginx-extras-oci:
    # cap_drop: ["ALL"]
    # cap_add: ["NET_BIND_SERVICE"]   # only capability needed for :80/:443
    container_name: nginx-extras-oci
    environment:
      TZ: "America/Los_Angeles"
    image: prplanit/nginx-extras-oci:latest
    labels:
      - "ap.mon.hostname=cell-membrane"
      - "ap.mon.srvcname=nginx"
    logging:
      <<: *loki
    # network_mode: host
    # You bind the ports you want; uncomment if you want 80/443 on host:
    ports:
      - "0.0.0.0:80:80"
      - "0.0.0.0:443:443"
      - "[::]:80:80"
      - "[::]:443:443"
    # read_only: true
    restart: always
    security_opt:
      - no-new-privileges:true
    # user: "101:101"                 # run as nginx user (Alpine uid/gid 101) instead of root
    tmpfs:
      # - /var/run/nginx:rw,noexec,nosuid,nodev,size=16m
      - /var/cache/nginx:rw,noexec,nosuid,nodev,size=64m
    volumes:
      # NGINX configs & virtual hosts
      # You can override the default nginx.conf:
      # - /opt/docker/nginx-extras/nginx.conf:/etc/nginx/nginx.conf:ro
      # I plan to move conf.d from the vanilla location, here nginx conf.d is mapped as my CI tasks currently expect.
      - /etc/nginx/conf.d:/etc/nginx/conf.d:ro
      - /opt/docker/nginx-extras/snippets:/etc/nginx/snippets:ro
      # persisted TLS params (dhparam.pem lives here)
      - /opt/docker/nginx-extras/ssl:/etc/nginx/ssl
      # Passthru existing dhparam.pem for existing configs.
      - /etc/nginx/dhparam.pem:/etc/nginx/dhparam.pem
      # full Let's Encrypt tree persisted to host (live/ archive/ renewal/)
      - /opt/docker/nginx-extras/letsencrypt:/etc/letsencrypt
      # logs to files (we also mirror to stdout/stderr for Loki)
      - /opt/docker/nginx-extras/logs:/var/log/nginx
      # DNS Config: Passthru systemd resolv.conf to mirror host DNS.
      - /run/systemd/resolve/resolv.conf:/etc/resolv.conf:ro   
      # share nginx pid with certbot for SIGHUP on renew
      - /var/run/nginx:/var/run/nginx
      # Contains a list of cloudflare ips, I am deprecating this static list soon.
      - /etc/nginx/cloudflare:/etc/nginx/cloudflare
      # HTML ASSETS; i.e. html, css, error pages, images, etc.
      - /mnt/timecapsule/Server/Web-App/NGINX:/mnt/timecapsule/Server/Web-App/NGINX
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8080/healthz >/dev/null"]
      interval: 30s
      timeout: 5s
      retries: 3
